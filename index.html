<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inventory Count Import</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body, html { margin:0; padding:0; font-family:'Inter', Arial, sans-serif; background-color:#f5f7fa; color:#333; }
    .site-header { display:flex; align-items:center; padding:15px 40px; background-color:#c8102e; }
    .site-header img.logo { height:40px; margin-right:20px; }
    .site-header h1 { font-size:1.6rem; margin:0; color:#fff; font-weight:600; }
    .container { max-width:1000px; margin:30px auto; padding:0 20px; }
    .section { background:#fff; border:1px solid #dde2e6; border-radius:6px; padding:20px; margin-bottom:30px; box-shadow:0 1px 3px rgba(0,0,0,0.05); }
    .section h2 { color:#000; margin-top:0; font-weight:600; }
    .section p { margin:-5px 0 15px 0; color:#555; font-size:0.95rem; }
    input, textarea { width:100%; box-sizing:border-box; padding:10px; border:1px solid #c1c7cd; border-radius:4px; margin-bottom:15px; }
    textarea { resize:vertical; height:200px; }
    button { background-color:#666; color:white; border:none; border-radius:4px; padding:10px 20px; cursor:pointer; font-weight:600; }
    button:hover { background-color:#444; }
    table { width:100%; border-collapse:collapse; margin-top:10px; font-size:0.9rem; }
    table, th, td { border:1px solid #d1d5da; }
    th, td { padding:6px; text-align:left; }
    td.empty { background-color:#fbeaea; }
    .warning { color:crimson; font-weight:600; margin-top:10px; }
  </style>
</head>
<body>
  <header class="site-header">
    <img src="element-logo.png" alt="Element Logic Logo" class="logo">
    <h1>Inventory Count Import - XML Converter</h1>
  </header>

  <div class="container">
    <div class="section">
      <h2>1. Upload Excel</h2>
      <p>Upload Excel template with SKU numbers to create an Inventory Count List.</p>
      <input type="file" id="fileInput" accept=".xlsx,.xls">
      <button onclick="processFile()">Convert Excel â†’ XML</button>
      <button onclick="downloadTemplate()">Download Template</button>
      <div id="splitWarningTop" class="warning" style="display:none;">Warning: ReferenceName was split into multiple XML blocks due to unique values.</div>
    </div>

    <div class="section">
      <h2>2. Excel Preview (first 10 rows)</h2>
      <div id="previewContainer" style="overflow:auto; max-height:300px;">
        <table id="previewTable"><thead><tr></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <div class="section">
      <h2>3. Request Body (XML)</h2>
      <p>Copy this XML content into your preferred API client or automation tool (e.g., Postman, Insomnia, cURL) to send it to your endpoint.</p>
      <textarea id="requestBody" placeholder="Converted XML will appear here"></textarea>
      <button onclick="downloadRequest()">Download Request Body</button>
    </div>

    <div class="section">
      <h2>4. Split ReferenceName XMLs</h2>
      <p class="warning" id="splitWarning" style="display:none;">Warning: ReferenceName was split into multiple XML blocks due to unique values.</p>
      <textarea id="splitRequestBody" placeholder="Split XMLs will appear here" readonly style="height:200px;"></textarea>
      <button id="downloadZipBtn" disabled>Download All Split XMLs (ZIP)</button>
    </div>
  </div>

<script>
let convertedRows = [];
let convertedText = '';
let lastSplitXmlBlocks = [];
const headerMap = {
  "referencename": "ReferenceName",
  "extproductid": "ExtProductId",
  "batchid": "BatchId",
  "extlocationid": "ExtLocationId",
  "clientcode": "ClientCode",
  "ownercode": "OwnerCode",
  "handlingunitscancode": "HandlingUnitScanCode",
  "handlingunitquantity": "HandlingUnitQuantity"
};

function normalizeHeaders(rows) {
  return rows.map(row => {
    let newRow = {};
    Object.values(headerMap).forEach(k => newRow[k] = "");
    for (let key in row) {
      if (!row.hasOwnProperty(key)) continue;
      let cleanKey = key.trim().toLowerCase();
      let mappedKey = headerMap[cleanKey];
      if (mappedKey) newRow[mappedKey] = row[key] ?? "";
    }
    return newRow;
  });
}

function processFile() {
  const fileInput = document.getElementById("fileInput");
  const file = fileInput.files[0];
  if (!file) { alert("Please select an Excel file."); return; }

  const reader = new FileReader();
  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    let rows = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
    rows = rows.filter(row => Object.values(row).some(v => v !== null && v.toString().trim() !== ""));
    if (rows.length === 0) { alert("No valid rows found in Excel file."); return; }

    convertedRows = normalizeHeaders(rows);
    convertedText = transformToXML(convertedRows);
    document.getElementById("requestBody").value = convertedText;
    renderPreview(rows);

    lastSplitXmlBlocks = createSplitXML(convertedRows);
    const splitWarning = document.getElementById('splitWarning');
    const splitWarningTop = document.getElementById('splitWarningTop');
    if (lastSplitXmlBlocks.length > 1) { 
      splitWarning.style.display = 'block';
      splitWarningTop.style.display = 'block';
    } else { 
      splitWarning.style.display = 'none';
      splitWarningTop.style.display = 'none';
    }
    document.getElementById('downloadZipBtn').disabled = lastSplitXmlBlocks.length === 0;

    // Show split request body in section 4
    document.getElementById('splitRequestBody').value = lastSplitXmlBlocks.join('\n\n<!-- SPLIT -->\n\n');
  };
  reader.readAsArrayBuffer(file);
}

function transformToXML(data) {
  let xml = `<?xml version="1.0" encoding="utf-8"?>\n`;
  xml += `<ImportOperation xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">\n  <Lines>\n`;
  data.forEach(row => {
    xml += `    <InventoryLine>\n`;
    Object.values(headerMap).forEach(field => {
      const value = row[field] ?? "";
      if (value.toString().trim() !== "") { xml += `      <${field}>${escapeXml(value)}</${field}>\n`; }
    });
    xml += `    </InventoryLine>\n`;
  });
  xml += `  </Lines>\n</ImportOperation>`;
  return xml;
}

function escapeXml(str) {
  return str.toString().replace(/[<>&'\"]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;','\'':'&apos;','"':'&quot;'}[c]));
}

function renderPreview(rows) {
  const previewTable = document.getElementById("previewTable");
  const thead = previewTable.querySelector("thead tr");
  const tbody = previewTable.querySelector("tbody");
  thead.innerHTML = "";
  tbody.innerHTML = "";
  const previewRows = rows.slice(0, 10);
  const headers = [...new Set(previewRows.flatMap(r => Object.keys(r)))];
  headers.forEach(h => { const th = document.createElement("th"); th.textContent = h; thead.appendChild(th); });
  previewRows.forEach(row => {
    const tr = document.createElement("tr");
    headers.forEach(h => {
      const td = document.createElement("td");
      const val = row[h] ?? "";
      td.textContent = val;
      if (val.toString().trim() === "") td.classList.add("empty");
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

function downloadRequest() {
  const body = document.getElementById("requestBody").value;
  if (!body) { alert("No request body to download."); return; }
  const blob = new Blob([body], { type: "application/xml" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "request.xml";
  a.click();
  URL.revokeObjectURL(a.href);
}

function downloadTemplate() {
  window.location.href = "InventoryCountXMLConvert_Template.xlsx";
}

function createSplitXML(rows) {
  const groups = {};
  rows.forEach(row => {
    const key = String(row.ReferenceName ?? '').trim() || '<EMPTY>';
    if (!groups[key]) groups[key] = [];
    groups[key].push(row);
  });
  return Object.keys(groups).map(ref => buildSingleXML(groups[ref], ref));
}

function buildSingleXML(data, refNameForComment) {
  let xml = `<?xml version="1.0" encoding="utf-8"?>\n<!-- ReferenceName: ${escapeXml(refNameForComment)} -->\n`;
  xml += `<ImportOperation xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">\n  <Lines>\n`;
  data.forEach(row => {
    xml += `    <InventoryLine>\n`;
    Object.values(headerMap).forEach(field => {
      const val = row[field];
      if (String(val).trim() !== "") xml += `      <${field}>${escapeXml(val)}</${field}>\n`;
    });
    xml += `    </InventoryLine>\n`;
  });
  xml += `  </Lines>\n</ImportOperation>`;
  return xml;
}

// ZIP download
document.getElementById('downloadZipBtn').addEventListener('click', function(){
  if(!lastSplitXmlBlocks || lastSplitXmlBlocks.length===0) return;
  const zip = new JSZip();
  lastSplitXmlBlocks.forEach((xml, idx)=>{ zip.file(`reference_${idx+1}.xml`, xml); });
  zip.generateAsync({type:"blob"}).then(content=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(content); a.download="split_xmls.zip"; a.click(); URL.revokeObjectURL(a.href); });
});
</script>
</body>
</html>
